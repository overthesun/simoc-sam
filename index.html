<!DOCTYPE html>
<html>

<head>

<title>Socketio Test Server</title>
<script src="https://cdn.socket.io/4.4.0/socket.io.min.js"
        integrity="sha384-1fOn6VtTq3PWwfsOrk45LnYcGosJwzMHv+Xh/Jx5303FVOXzEnw0EpLv30mtjmlj"
        crossorigin="anonymous"></script>
<script>
// see https://socket.io/docs/v4/client-initialization/
var socket = null
const SENSORS_INFO = {}

document.addEventListener("DOMContentLoaded", function(event) {
    const textarea = document.getElementById('logbox')
    const msgbox = document.getElementById('msgbox')
    const numbox = document.getElementById('numbox')
    textarea.value = 'Status log:\n'
    msgbox.value = 'test'
    numbox.value = '10'
    window.setInterval(function() {
        const title = ' Socketio Test Server'
        if (socket?.connected) {
            document.title = 'ðŸŸ¢' + title
        }
        else {
            document.title = 'ðŸ”´' + title
        }
    }, 1000);
})

function init_socket() {
    console.log('Initializing socket...')
    socket = io()
    socket.on('connect', () => {
        log_event('Connected to server')
        log_event('Registering client')
        socket.emit('register-client')
    })
    socket.on('disconnect', () => {
        log_event('Server disconnected')
        socket.disconnect()  // don't try to reconnect
        socket = null
    })
    socket.on('hab-info', (info) => {
        log_event(`Habitat info: ${JSON.stringify(info, null, '\t')}`)
        log_event('Requesting step data')
        socket.emit('send-step-data')
    })
    socket.on('sensor-info', (info) => {
        log_event(`Sensor info: ${JSON.stringify(info, null, '\t')}`)
        Object.assign(SENSORS_INFO, info)
    })
    socket.on('step-batch',  (batch) => {
        //log_event(`Received a batch of ${batch.length} step from the server:`)
        batch.forEach((step) => {
            log_event(format_reading(step))
            // log_event(`  ${step.step_num}: CO2: ${step.co2_ppm.toFixed(1)}ppm; Temperature: ${step.temp.toFixed(2)}Â°; Humidity: ${step.hum_perc.toFixed(2)}%`)
        })
    })
    socket.on('log', log_event)
    socket.on('send_data', log_event)
}

function connect() {
    if (socket === null) {
        init_socket()
    }
    log_event('Connecting...')
    socket.connect()
}

function disconnect() {
    log_event('Disconnecting...')
    socket.disconnect()
    socket = null
}

function send_msg() {
    if (socket === null) {
        connect()
    }
    const msg = document.getElementById('msgbox').value
    log_event(`Sending msg: ${msg}`)
    socket.emit('msg', msg)
}

function get_data() {
    if (socket === null) {
        connect()
    }
    const n =  document.getElementById('numbox').value
    log_event(`Requesting ${n} random numbers`)
    socket.emit('get_data', n)
}

function log_event(event) {
    console.log(event)
    const textarea = document.getElementById('logbox')
    textarea.value += event + '\n'
    textarea.scrollTop = textarea.scrollHeight
}
function format_reading(reading) {
    let {step_num, timestamp, ...data} = reading
    timestamp = timestamp.split('.')[0] // remove millisec
    const reading_info = Object.values(SENSORS_INFO)[0].reading_info
    let result = []
    let step = data['n'] // n reported with data batch
    let sensor = Object.keys(data['readings'])[0]a
    sensor_data = data['readings'][sensor]
    Object.entries(sensor_data).forEach(([key, value]) => {
        let v = (typeof value === 'number') ? value.toFixed(2) : value
        let label = key
        if (! ( (label === 'timestamp') || (label === 'n')) ) {
            let unit = ''
            if (reading_info) {
                label = reading_info[key]['label']
                unit = ` ${reading_info[key]['unit']}`
            }
            result.push(`${label}: ${v}${unit}`)
        }
    })
    return ` ${sensor}|${step}|${timestamp}  ` + result.join('; ')
}
</script>

<style>
body {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: repeat(3, 4em) 24em;
    color: #eee;
    background: linear-gradient(90deg, #111 0%, #333 50%, #111 100%);
    padding: 6em 20% 0;
}
div {
    margin: 0 auto;
    text-align: center;
}
button, input {
    font-size: 1.5em;
}
textarea {
    grid-column-start: 1;
    grid-column-end: 3;
    color: #0e0;
    background-color: #111;
    padding: 1em;
}
</style>

</head>


<body>
        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()">Disconnect</button>
        <input type="text" placeholder="Enter message" id="msgbox">
        <button onclick="send_msg()">Send message</button>
        <input type="number" min="0" max="10" id="numbox">
        <button onclick="get_data()">Get random nums</button>
        <textarea rows="20" readonly id="logbox"></textarea>
</body>

</html>
